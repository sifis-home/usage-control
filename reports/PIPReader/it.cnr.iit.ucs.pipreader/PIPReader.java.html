<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>PIPReader.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">coverage</a> &gt; <a href="../index.html" class="el_bundle">PIPReader</a> &gt; <a href="index.source.html" class="el_package">it.cnr.iit.ucs.pipreader</a> &gt; <span class="el_source">PIPReader.java</span></div><h1>PIPReader.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyright 2018 IIT-CNR
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License. You may obtain a copy
 * of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 ******************************************************************************/
package it.cnr.iit.ucs.pipreader;

import it.cnr.iit.ucs.exceptions.PIPException;
import it.cnr.iit.ucs.journaling.JournalBuilder;
import it.cnr.iit.ucs.journaling.JournalingInterface;
import it.cnr.iit.ucs.obligationmanager.ObligationInterface;
import it.cnr.iit.ucs.pip.PIPBase;
import it.cnr.iit.ucs.pip.PIPSubscriberTimer;
import it.cnr.iit.ucs.properties.components.PipProperties;
import it.cnr.iit.utility.FileUtility;
import it.cnr.iit.utility.errorhandling.Reject;
import it.cnr.iit.xacml.Attribute;
import oasis.names.tc.xacml.core.schema.wd_17.RequestType;

import java.io.BufferedReader;
import java.io.FileReader;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.logging.Logger;

/**
 * The task this PIP is to read data from a file when requested.
 * The Path to reach the file is passed as parameter to the pip.
 *
 * @author Antonio La Marra, Alessandro Rosetti
 */
public class PIPReader extends PIPBase {

<span class="fc" id="L49">    private static final Logger log = Logger.getLogger(PIPReader.class.getName());</span>
    private JournalingInterface journal;

    public static final String FILE_PATH_KEYWORD = &quot;FILE_PATH&quot;;

    /**
     * Map having attributeId as key and the file path as value
     */
<span class="fc" id="L57">    private final Map&lt;String, String&gt; filePathMap = new HashMap&lt;&gt;();</span>

    public PIPReader(PipProperties properties) {
<span class="fc" id="L60">        super(properties);</span>
<span class="fc" id="L61">        Reject.ifFalse(init(properties), &quot;Error initialising pip : &quot; + properties.getId());</span>
<span class="fc" id="L62">    }</span>

    @Override
    public boolean init(PipProperties properties) {
        try {
<span class="fc bfc" id="L67" title="All 2 branches covered.">            for (Map&lt;String, String&gt; attributeMap : properties.getAttributes()) {</span>

<span class="fc" id="L69">                Attribute attribute = new Attribute();</span>
<span class="fc" id="L70">                buildAttribute(attribute, attributeMap);</span>

                // extract the file name from the additionalProperties, as value of the entry with
                // the key matching this attributeId
<span class="fc" id="L74">                String filePath = properties.getAdditionalProperties().get(attribute.getAttributeId());</span>
<span class="fc" id="L75">                Reject.ifNull(filePath, &quot;Missing file path&quot;);</span>
<span class="fc" id="L76">                Reject.ifTrue(filePath.equals(&quot;&quot;), &quot;Empty file path&quot;);</span>
<span class="fc" id="L77">                setFilePath(attribute.getAttributeId(), filePath);</span>

<span class="fc" id="L79">                addAttribute(attribute);</span>

<span class="fc" id="L81">                journal = JournalBuilder.build(properties);</span>

                // timer for polling the value of the attribute
<span class="fc" id="L84">                PIPSubscriberTimer subscriberTimer = new PIPSubscriberTimer(this);</span>
<span class="fc" id="L85">                subscriberTimer.setRate(properties.getRefreshRate());</span>
<span class="fc" id="L86">                subscriberTimer.start();</span>
<span class="fc" id="L87">            }</span>
<span class="fc" id="L88">            return true;</span>
<span class="fc" id="L89">        } catch (Exception e) {</span>
<span class="fc" id="L90">            return false;</span>
        }
    }


    /**
     * Retrieve the value of the attribute passed as argument.
     * If the value is not of type environment, this method uses the additionalInformation
     * (which has to be set beforehand) to select the right value from the file.
     * Then, it sets the value within the attribute, and finally returns a String
     * containing such a value.
     */
    @Override
    public String retrieve(Attribute attribute) throws PIPException {

<span class="fc" id="L105">        String filePath = this.filePathMap.get(attribute.getAttributeId());</span>
        String value;
<span class="fc bfc" id="L107" title="All 2 branches covered.">        if (isEnvironmentCategory(attribute)) {</span>
<span class="fc" id="L108">            value = read(filePath);</span>
        } else {
<span class="fc" id="L110">            value = read(filePath, attribute.getAdditionalInformation());</span>
        }
<span class="fc" id="L112">        attribute.setValue(attribute.getDataType(), value);</span>
<span class="fc" id="L113">        return value;</span>
    }

    /**
     * Effective retrieval of the monitored value.
     *
     * @return the requested value
     * @throws PIPException if the value cannot be retrieved
     */
    private String read(String filePath) throws PIPException {
        try {
<span class="fc" id="L124">            Path path = Paths.get(filePath);</span>
            // TODO UCS-33 NOSONAR
<span class="fc" id="L126">            String value = new String(Files.readAllBytes(path));</span>
<span class="fc" id="L127">            journal.logString(formatJournaling(value));</span>
<span class="fc" id="L128">            return value;</span>
<span class="nc" id="L129">        } catch (IOException e) {</span>
<span class="nc" id="L130">            throw new PIPException(&quot;Attribute Manager error : &quot; + e.getMessage());</span>
        }
    }

    /**
     * Effective retrieval of the monitored value looking for the line containing a filter.
     * Note that each line of the file MUST be composed of two fields separated
     * by either one or more spaces or tab, e.g.:
     * filter attribute
     * filter   attribute
     * filter\tattribute.
     *
     * @param filter the string to be used to search for the item we're interested into
     * @return the requested value
     * @throws PIPException if the value cannot be retrieved
     */
    private String read(String filePath, String filter) throws PIPException {
        // TODO UCS-33 NOSONAR
<span class="fc" id="L148">        try (BufferedReader br = new BufferedReader(new FileReader(filePath))) {</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">            for (String line; (line = br.readLine()) != null; ) {</span>
<span class="fc" id="L150">                String key = line.split(&quot;\\s+&quot;)[0];</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">                if (key.equals(filter)) {</span>
<span class="fc" id="L152">                    String value = line.split(&quot;\\s+&quot;)[1];</span>
<span class="fc" id="L153">                    journal.logString(formatJournaling(value, filter));</span>
<span class="fc" id="L154">                    return value;</span>
                }
<span class="fc" id="L156">            }</span>
<span class="nc" id="L157">        } catch (Exception e) {</span>
<span class="nc" id="L158">            throw new PIPException(&quot;Attribute Manager error: &quot; + e.getMessage());</span>
<span class="fc" id="L159">        }</span>
<span class="fc" id="L160">        throw new PIPException(&quot;Attribute Manager: unable to retrieve a value for filter: \&quot;&quot; + filter + &quot;\&quot;\n&quot;);</span>
    }

    private void setFilePath(String attributeId, String filePath) {
<span class="fc" id="L164">        String absFilePath = FileUtility.findFileAbsPathUsingClassLoader(filePath);</span>
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">        if (absFilePath != null) {</span>
<span class="fc" id="L166">            this.filePathMap.put(attributeId, absFilePath);</span>
        } else {
<span class="nc" id="L168">            this.filePathMap.put(attributeId, filePath);</span>
        }
<span class="fc" id="L170">        Reject.ifNull(this.filePathMap.get(attributeId));</span>
<span class="fc" id="L171">    }</span>

    private String formatJournaling(String... strings) {
<span class="fc" id="L174">        StringBuilder logStringBuilder = new StringBuilder();</span>
<span class="fc" id="L175">        logStringBuilder.append(&quot;VALUE READ: &quot;).append(strings[0]);</span>

<span class="fc bfc" id="L177" title="All 2 branches covered.">        if (strings.length &gt; 1) {</span>
<span class="fc" id="L178">            logStringBuilder.append(&quot; FOR FILTER: &quot;).append(strings[1]);</span>
        }
<span class="fc" id="L180">        return logStringBuilder.toString();</span>
    }

    @Override
    public void update(String data) throws PIPException {
// fixme: who is supposed to call this?
//        try {
//            Path path = Paths.get( filePath );
//            Files.write( path, data.getBytes() );
//        } catch( IOException e ) {
//            log.severe( &quot;Error updating attribute : &quot; + e.getMessage() );
//        }
<span class="nc" id="L192">        System.err.println(&quot;update() method not implemented&quot;);</span>
<span class="nc" id="L193">    }</span>

    @Override
    public void retrieve(RequestType request,
                         List&lt;Attribute&gt; attributeRetrievals) {
<span class="nc" id="L198">        log.severe(&quot;Multiple retrieve is unimplemented&quot;);</span>
<span class="nc" id="L199">    }</span>

    @Override
    public void subscribe(RequestType request,
                          List&lt;Attribute&gt; attributeRetrieval) {
<span class="nc" id="L204">        log.severe(&quot;Multiple subscribe is unimplemented&quot;);</span>
<span class="nc" id="L205">    }</span>

    @Override
    public void performObligation(ObligationInterface obligation) {
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (obligation != null) {</span>
<span class="nc" id="L210">            log.severe(&quot;Perform obligation is unimplemented&quot;);</span>
        }
<span class="nc" id="L212">    }</span>


    @Override
    protected Logger getLogger() {
<span class="fc" id="L217">        return log;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>